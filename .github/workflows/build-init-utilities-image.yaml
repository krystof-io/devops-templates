name: Build init utilities image

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfiles/init-utilities/**'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: arc-runners-basic
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate image tag
        id: tag
        run: |
          # Use short Git hash as tag
          IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $IMAGE_TAG"

      - name: Login to internal private docker repo
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #v3.6.0
        with:
          registry: ${{ vars.IMAGE_REGISTRY_HOST }}
          username: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
          password: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ steps.tag.outputs.tag }}"
          IMAGE_NAME="${{ vars.IMAGE_REGISTRY_HOST }}/init-utilities:${IMAGE_TAG}"
          
          echo "Building image: ${IMAGE_NAME}"
          
          docker build \
            -f Dockerfiles/init-utilities/Dockerfile \
            -t "${IMAGE_NAME}" \
            .
          
          docker push "${IMAGE_NAME}"
          
          # Also tag and push as 'latest'
          docker tag "${IMAGE_NAME}" "${{ vars.IMAGE_REGISTRY_HOST }}/krystof-io/init-utilities:latest"
          docker push "${{ vars.IMAGE_REGISTRY_HOST }}/krystof-io/init-utilities:latest"

          echo "Successfully built and pushed:"
          echo "  - ${IMAGE_NAME}"